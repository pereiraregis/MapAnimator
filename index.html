<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Map Animator</title>
    <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; display: flex; background: #111; color: #ececec; height: 100vh; }
        #map-viewport { position: relative; flex-grow: 1; display: flex; align-items: center; justify-content: center; overflow: hidden; background: #000; }
        #map { width: 100%; height: 100%; transition: width 0.3s, height 0.3s; }
        
        .sidebar { width: 380px; padding: 20px; overflow-y: auto; height: 100vh; box-sizing: border-box; border-right: 1px solid #333; background: #1a1a1a; z-index: 10; }
        .point-card { background: #252525; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #3b82f6; position: relative; }
        
        label { display: block; font-size: 10px; color: #888; margin-bottom: 4px; text-transform: uppercase; font-weight: 700; }
        input, select, button { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #333; background: #111; color: white; margin-bottom: 5px; font-size: 12px; }
        
        .flex-row { display: flex; gap: 5px; }
        button { background: #3b82f6; border: none; font-weight: 600; cursor: pointer; color: white; }
        button:hover { background: #2563eb; }
        .btn-add { background: #4b5563; margin-bottom: 20px; }
        .btn-capture { background: #059669; font-size: 10px; }
        .btn-remove { background: #991b1b; width: 30px; position: absolute; right: 10px; top: 10px; padding: 2px; }
        
        #startBtn { background: #10b981; font-size: 14px; padding: 15px; margin-top: 20px; }
        #status-container { margin-top: 15px; padding: 10px; background: #000; font-family: monospace; border: 1px solid #333; }
        .progress-bar { height: 4px; background: #10b981; width: 0%; margin-top: 8px; }
    </style>
</head>
<body>

<div class="sidebar">
    <h2>Map Animator</h2>
    <p style="font-size: 11px; color: #555; margin-bottom: 20px;">Multi-Point & Resolution Control</p>

    <label>Output Resolution</label>
    <select id="res-preset" onchange="updateViewport()">
        <option value="1920x1080">16:9 - Full HD (1920x1080)</option>
        <option value="3840x2160">16:9 - 4K Ultra HD (3840x2160)</option>
        <option value="1080x1920">9:16 - Vertical (1080x1920)</option>
    </select>

    <div id="points-list">
        </div>

    <button class="btn-add" onclick="addPoint()">+ Add Waypoint</button>

    <div class="flex-row">
        <div style="flex: 1;"><label>Secs Per Leg</label><input type="number" id="duration" value="3"></div>
        <div style="flex: 1;"><label>FPS</label><input type="number" id="fps" value="24"></div>
    </div>

    <button id="startBtn" onclick="generateZip()">RENDER SEQUENCE (ZIP)</button>
    
    <div id="status-container">
        <div id="status-text" style="color: #10b981;">Ready to fly.</div>
        <div class="progress-bar" id="progress"></div>
    </div>
</div>

<div id="map-viewport">
    <div id="map"></div>
</div>

<script>
    let points = [];
    const map = new maplibregl.Map({
        container: 'map',
        style: 'https://tiles.openfreemap.org/styles/bright',
        center: [-46.633, -23.550],
        zoom: 12,
        preserveDrawingBuffer: true,
        antialias: true
    });

    map.on('style.load', () => {
        map.getStyle().layers.forEach(l => {
            if (l.id.includes('poi') || l.id.includes('place') || l.id.includes('building')) map.removeLayer(l.id);
        });
        addPoint(); // Add initial point
        addPoint(); // Add second point
    });

    function updateViewport() {
        const [w, h] = document.getElementById('res-preset').value.split('x').map(Number);
        const container = document.getElementById('map-viewport');
        const mapDiv = document.getElementById('map');
        
        const scale = Math.min((container.clientWidth - 40) / w, (container.clientHeight - 40) / h);
        mapDiv.style.width = w + 'px';
        mapDiv.style.height = h + 'px';
        mapDiv.style.transform = `scale(${scale})`;
        map.resize();
    }
    window.addEventListener('resize', updateViewport);

    function addPoint() {
        const id = Date.now();
        const c = map.getCenter();
        const pt = { id, lat: c.lat, lng: c.lng, zoom: map.getZoom(), pitch: map.getPitch(), bearing: map.getBearing() };
        points.push(pt);
        renderPoints();
    }

    function removePoint(id) {
        if(points.length <= 2) return alert("Min 2 points required");
        points = points.filter(p => p.id !== id);
        renderPoints();
    }

    function capturePoint(id) {
        const idx = points.findIndex(p => p.id === id);
        const c = map.getCenter();
        points[idx] = { id, lat: c.lat, lng: c.lng, zoom: map.getZoom(), pitch: map.getPitch(), bearing: map.getBearing() };
        renderPoints();
    }

    function renderPoints() {
        const list = document.getElementById('points-list');
        list.innerHTML = '';
        points.forEach((p, i) => {
            const card = document.createElement('div');
            card.className = 'point-card';
            card.innerHTML = `
                <label>Waypoint ${i + 1}</label>
                <div style="font-size:9px; color:#aaa; margin-bottom:5px;">
                    ${p.lat.toFixed(4)}, ${p.lng.toFixed(4)} | Z: ${p.zoom.toFixed(1)}
                </div>
                <button class="btn-capture" onclick="capturePoint(${p.id})">Update to Current View</button>
                ${i > 1 ? `<button class="btn-remove" onclick="removePoint(${p.id})">Ã—</button>` : ''}
            `;
            list.appendChild(card);
        });
    }

    async function generateZip() {
        const durationPerLeg = parseFloat(document.getElementById('duration').value);
        const fps = parseInt(document.getElementById('fps').value);
        const totalFramesPerLeg = Math.ceil(durationPerLeg * fps);
        const zip = new JSZip();
        const btn = document.getElementById('startBtn');
        btn.disabled = true;

        let frameCount = 0;

        // Iterate through each segment (Leg)
        for (let p = 0; p < points.length - 1; p++) {
            const start = points[p];
            const end = points[p+1];

            for (let i = 0; i < totalFramesPerLeg; i++) {
                const t = i / totalFramesPerLeg;
                // Cubic easing for smooth transition between legs
                const easedT = t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;

                // FIX: Logarithmic Zoom + Simultaneous Lerp
                const lat = start.lat + (end.lat - start.lat) * easedT;
                const lng = start.lng + (end.lng - start.lng) * easedT;
                const zoom = start.zoom + (end.zoom - start.zoom) * easedT;
                const pitch = start.pitch + (end.pitch - start.pitch) * easedT;
                const bearing = start.bearing + (end.bearing - start.bearing) * easedT;

                map.jumpTo({ center: [lng, lat], zoom: zoom, pitch: pitch, bearing: bearing });
                await new Promise(r => map.once('idle', r));

                const imgData = map.getCanvas().toDataURL('image/png').split(',')[1];
                zip.file(`frame_${String(frameCount).padStart(5, '0')}.png`, imgData, {base64: true});
                
                frameCount++;
                const totalTarget = totalFramesPerLeg * (points.length - 1);
                const percent = Math.round((frameCount / totalTarget) * 100);
                document.getElementById('progress').style.width = percent + "%";
                document.getElementById('status-text').innerText = `Rendering: ${percent}%`;
            }
        }

        document.getElementById('status-text').innerText = "Compressing ZIP...";
        const content = await zip.generateAsync({type:"blob"});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(content);
        link.download = `map_animation_${document.getElementById('res-preset').value}.zip`;
        link.click();
        btn.disabled = false;
        document.getElementById('status-text').innerText = "Done!";
    }
</script>

</body>
</html>